services:
  sqlserver:
    build:
      context: ./sqlserver
      dockerfile: Dockerfile.mssql
    image: zefirnikolov/webshop-sqlserver:1
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${WSHP_SQLSERVER_ROOT_PASSWORD:-Zur1ch^2026_Data!1}"
      APP_DB_NAME: "${WSHP_SQLSERVER_DB_NAME:-sqldb}"
      APP_DB_LOGIN: "${WSHP_SQLSERVER_USER:-cash100m}"
      APP_DB_PASSWORD: "${WSHP_DB_PASSWORD:-Zur1ch^2026_Data!1}"
    # ports:
    #   - "1433:1433"
    # volumes:
    #   - mssql-data:/var/opt/mssql
    networks:
      - data-network
    restart: always

  server:
    build:
      context: ./api-server
      dockerfile: Dockerfile.net8
    image: zefirnikolov/webshop-apiserver:1
    environment:
      DB_HOST: "sqlserver"
      DB_USER: "${WSHP_SQLSERVER_USER:-cash100m}"
      DB_USER_PASSWORD: "${WSHP_DB_PASSWORD:-Zur1ch^2026_Data!1}"
      DB_NAME: "${WSHP_SQLSERVER_DB_NAME:-sqldb}"
      DB_TRUST_SERVER_CERT: "true"
      ASPNETCORE_URLS: "http://+:5000"
      REDIS_CONNECTION: "redis:6379,password=${WSHP_REDIS_PASSWORD:-Zur1ch^2026_Redis!1},abortConnect=false"
      CACHE_TTL_MINUTES: "360"
    depends_on:
      - sqlserver
    # ports:
    #   - "5000:5000"
    networks:
      - app-network
      - data-network
    restart: always

  redis:
    image: redis:7-alpine
    command:
      [
        "redis-server",
        "--appendonly", "no",
        "--protected-mode", "yes",
        "--requirepass", "${WSHP_REDIS_PASSWORD:-Zur1ch^2026_Redis!1}",
        "--maxmemory", "64mb",
        "--maxmemory-policy", "allkeys-lru"
      ]
    # no ports -> not exposed outside Docker
    networks:
      - data-network
    restart: always

  warmer:
    image: alpine:3
    environment:
      WARM_TARGET: "http://web:8080"
      WARM_PATHS: "/ /products"
      WARM_INTERVAL_SECONDS: "3600"       # 1 hour
      WARM_INITIAL_DELAY_SECONDS: "120"   # initial delay before first warm
      CURL_TIMEOUT_SECONDS: "300"
    command: >
      sh -c '
        set -eu;
        apk add --no-cache curl >/dev/null;
        echo "[warmer] $$(date -u) initial sleep $${WARM_INITIAL_DELAY_SECONDS}s...";
        sleep $${WARM_INITIAL_DELAY_SECONDS};
        while true; do
          for p in $${WARM_PATHS}; do
            echo "[warmer] $$(date -u) warming: $${WARM_TARGET}$${p}";
            curl -fsS --max-time $${CURL_TIMEOUT_SECONDS} "$${WARM_TARGET}$${p}" >/dev/null || echo "[warmer] WARN: failed $${p}";
          done;
          sleep $${WARM_INTERVAL_SECONDS};
        done
      '
    depends_on:
      - web
    networks:
      - app-network
    restart: always

  web:
    build:
      context: .
      dockerfile: Dockerfile-fe
    image: server:9
    environment:
      PRODUCTS_URL: "http://server:5000/api/products"
    depends_on:
      - server
    # ports:
    #   - "8080:8080"
    networks:
      - app-network
    restart: always

  reverse-proxy:
    build:
      context: .
      dockerfile: Dockerfile-reverse-proxy
    image: reverse-proxy:2
    depends_on:
      - sqlserver
      - web
      - server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./reverse-proxy.conf:/etc/nginx/nginx.conf:ro
      - ./certs/:/etc/nginx/certs
      - ./nginx-cache/:/var/cache/nginx
    networks:
      - app-network
    restart: always


networks:
  app-network:
    driver: bridge
  data-network:
    driver: bridge
    internal: true

# volumes:
#   mssql-data:
